name: Run tests on PR

# on: [pull_request]

on:
  pull_request:
    branches: [ "develop" ]

jobs:
  main:
    runs-on: $RUNS_ON
    timeout-minutes: 35

    steps:
      - name: Install SSH key for access to repository.
        uses: webfactory/ssh-agent@v0.6.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_FASTLANE_COMMIT }}
      
      - uses: actions/checkout@v3.1.0
        with:
          ref: ${{ github.event.inputs.branch }}

      - uses: actions/update-git-config@v1

      - uses: maxim-lobanov/setup-xcode@v1.5.1
        with:
          xcode-version: $XCODE_VERSION

      - name: Download Middleware
        run: ruby ./Scripts/middleware.rb --token ${{ secrets.ANYTYPE_MIDDLEWARE_ACCESS_TOKEN }}

      - name: Run unit tests
        run: bundle exec fastlane tests
        continue-on-error: true
        env:
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 900
          FASTLANE_XCODE_LIST_TIMEOUT: 900
