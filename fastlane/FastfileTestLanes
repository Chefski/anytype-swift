default_platform(:ios)

platform :ios do

  # Test build

  lane :test_build do
    setup_ci
    match(readonly: true)

    desc "Runs all the tests"
    build_app(
      scheme: "Anytype", 
      configuration: "Dev-Release",
      use_system_scm: true,
      build_path: "./build_path",
      archive_path: "./archive_path",
      derived_data_path: "./derived_data"
    )

    scan(
     devices: ["iPhone 8"], 
      scheme: "AnytypeTests",
      #slack_url: "https://hooks.slack.com/services/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",
      #slack_only_on_failure: true,
      fail_build: false,
      derived_data_path: "./derived_data",
      #test_without_building: true,
      #skip_build: true,
      skip_package_dependencies_resolution: true
      #configuration: "Release"
    )

  end

  # Bump dev build number

  lane :bump_dev_build_number do
    ensure_git_status_clean

    build_number = increment_build_number(xcodeproj: "Anytype.xcodeproj")
    version = get_version_number(xcodeproj: "Anytype.xcodeproj", target: "Anytype")

    commit_version_bump(
      message: "Bump version #{version}(#{build_number})",
      xcodeproj: "Anytype.xcodeproj",
      no_verify: true
    )

    add_git_tag(tag: "dev/#{version}/#{build_number}")
  end

end