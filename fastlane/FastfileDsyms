default_platform(:ios)

platform :ios do
  
  lane :update_dev_symbols do |options|
    update_symbols(
      version: options[:version],
      build_number: options[:build_number],
      gsp_path: './Anytype/Resources/Plists/GoogleService-Info-Dev.plist'
    )
  end

  lane :update_release_symbols do |options|
    update_symbols(
      version: options[:version],
      build_number: options[:build_number],
      gsp_path: './Anytype/Resources/Plists/GoogleService-Info.plist'
    )
  end

  # Private lane

  private_lane :update_symbols do |options|
    app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
        duration: 1200,
        in_house: false
    )

    is_version_empty = !options[:version] || options[:version] == ""
    is_build_number_empty = !options[:build_number] || options[:build_number] == ""

    if is_version_empty && is_build_number_empty
      download_dsyms(
        version: 'latest'
      )
    elsif is_build_number_empty
      download_dsyms(
        version: options[:version]
      )
    else
      download_dsyms(
        version: options[:version],
        build_number: options[:build_number]
      )
    end

    upload_symbols_to_crashlytics(
      gsp_path: options[:gsp_path],
      binary_path: './Scripts/firebase/upload-symbols',
      dsym_worker_threads: 2,
      debug: true
    )
  end

end
