default_platform(:ios)

platform :ios do
  
  lane :download_dev_symbols do
    download_symbols
  end

  lane :download_release_symbols do
    download_symbols
  end

  lane :update_dev_symbols do |options|
    update_symbols(
      version: options[:version],
      build_number: options[:build_number],
      gsp_path: './Anytype/Resources/Plists/GoogleService-Info-Dev.plist'
    )
  end

  lane :update_release_symbols do |options|
    update_symbols(
      version: options[:version],
      build_number: options[:build_number],
      gsp_path: './Anytype/Resources/Plists/GoogleService-Info.plist'
    )
  end

  # Private lane

  private_lane :update_symbols do |options|
    app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
        duration: 1200,
        in_house: false
    )

    download_dsyms(
      version: options[:version],
      build_number: options[:build_number]
    )

    upload_symbols_to_crashlytics(
      gsp_path: options[:gsp_path],
      binary_path: './Scripts/upload-symbols',
      debug: true
    )
  end

  private_lane :download_symbols do
    app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
        duration: 1200,
        in_house: false
    )

    download_dsyms(
      version: 'latest',
      wait_for_dsym_processing: true,
      wait_timeout: 4000
    )
  end

end
