default_platform(:ios)

platform :ios do

  lane :dev do
    deploy(
      release: false
    )
  end

  lane :release do
    deploy(
      release: true
    )
  end

  # Private lanes

  private_lane :deploy do |options| 
    xcodeproj = "Anytype.xcodeproj"
    current_branch = git_branch
    temp_branch = "#{current_branch}-temp"

    setup_ci
    match(readonly: true)
    
    ensure_git_status_clean(
      show_uncommitted_changes: true
    )

    sh("git checkout -b " + temp_branch)

    build_number = increment_build_number(xcodeproj: xcodeproj)
    version = get_version_number(xcodeproj: xcodeproj, target: "Anytype")

    commit_version_bump(
      message: "Bump version #{version}(#{build_number})",
      xcodeproj: xcodeproj,
      no_verify: true
    )

    if !options[:release] 
      add_badge(
        shield: "#{version}-#{build_number}-blue",
        no_badge: true
      )
    end
    
    build_app(
      scheme: "Anytype", 
      configuration: options[:release] ? "Release" : "Dev-Release",
      include_symbols: true,
      use_system_scm: true,
      output_directory: "./build_app_results"
    )

    upload_build_to_testflight
    upload_dsyms_to_crashlytics(release: options[:release])

    sh("git checkout " + current_branch)

    git_pull

    sh("git merge --ff --no-verify" + temp_branch)
    sh("git branch -d " + temp_branch)

    prefix = options[:release] ? "release" : "dev"
    tag_name = "#{prefix}/#{version}/#{build_number}"
    add_git_tag(
      tag: tag_name,
      force: true
    )

    # Reset icon changes
    reset_git_repo(skip_clean: true)

    push_to_git_remote

    app_name = options[:release] ? "Anytype" : "Anytype Dev",
    dsym_paths = []
    Dir.chdir("..") do
      dsym_paths = Dir["./build_app_results/*.dSYM.zip"]
    end


    set_github_release(
      repository_name: "anytypeio/ios-anytype",
      api_token: ENV['PERSONAL_TOKEN_FOR_GITHUB_RELEASE'],
      tag_name: tag_name,
      name: "#{app_name} #{version}(#{build_number})",
      upload_assets: dsym_paths
    )

  end

  private_lane :upload_build_to_testflight do 
    api_key = app_store_connect_api_key(
        key_id: ENV['APP_STORE_CONNECT_KEY_ID'],
        issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
        key_content: ENV['APP_STORE_CONNECT_KEY_CONTENT'],
        duration: 1200,
        in_house: false
    )

    upload_to_testflight(
      api_key: api_key, 
      skip_waiting_for_build_processing: true
    )
  end

  private_lane :upload_dsyms_to_crashlytics do |options|
    gsp_plist = options[:release] ? "GoogleService-Info.plist" : "GoogleService-Info-Dev.plist"
    dsym_paths = []

    Dir.chdir("..") do
      dsym_paths = Dir["./build_app_results/*.dSYM.zip"]
    end

    upload_symbols_to_crashlytics(
      dsym_paths: dsym_paths,
      gsp_path: "./Anytype/Resources/Plists/#{gsp_plist}",
      binary_path: './Scripts/firebase/upload-symbols',
      dsym_worker_threads: 2,
      debug: true
    )
  end

end
